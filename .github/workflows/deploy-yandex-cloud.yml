name: Deploy to Yandex Cloud

on:
  push:
    branches: [main]
    paths:
      - 'yandex-cloud/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
      
      - name: Authenticate Yandex Cloud
        run: |
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > key.json
          yc config set service-account-key key.json
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
      
      - name: Install dependencies
        working-directory: ./yandex-cloud
        run: |
          npm ci
      
      - name: Deploy Chat Function
        working-directory: ./yandex-cloud
        run: |
          yc serverless function version create \
            --function-name=widget-chat \
            --runtime nodejs22 \
            --entrypoint api/chat.cloudHandler \
            --memory 256MB \
            --execution-timeout 30s \
            --source-path . \
            --environment OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }},REDIS_HOST=${{ secrets.REDIS_HOST }},REDIS_PORT=${{ secrets.REDIS_PORT }},REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
      
      - name: Deploy Lead Function
        working-directory: ./yandex-cloud
        run: |
          yc serverless function version create \
            --function-name=widget-lead \
            --runtime nodejs22 \
            --entrypoint api/lead.cloudHandler \
            --memory 256MB \
            --execution-timeout 15s \
            --source-path . \
            --environment REDIS_HOST=${{ secrets.REDIS_HOST }},REDIS_PORT=${{ secrets.REDIS_PORT }},REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
      
      - name: Deploy Analytics Function
        working-directory: ./yandex-cloud
        run: |
          yc serverless function version create \
            --function-name=widget-analytics \
            --runtime nodejs22 \
            --entrypoint api/analytics.cloudHandler \
            --memory 128MB \
            --execution-timeout 10s \
            --source-path . \
            --environment REDIS_HOST=${{ secrets.REDIS_HOST }},REDIS_PORT=${{ secrets.REDIS_PORT }},REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
      
      - name: Deploy Health Function
        working-directory: ./yandex-cloud
        run: |
          yc serverless function version create \
            --function-name=widget-health \
            --runtime nodejs22 \
            --entrypoint api/health.cloudHandler \
            --memory 128MB \
            --execution-timeout 10s \
            --source-path . \
            --environment OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }},REDIS_HOST=${{ secrets.REDIS_HOST }},REDIS_PORT=${{ secrets.REDIS_PORT }},REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
      
      - name: Upload Static Files to Object Storage
        working-directory: ./yandex-cloud
        run: |
          if [ -n "${{ secrets.OBJECT_STORAGE_BUCKET }}" ]; then
            echo "Uploading widget-external.js..."
            yc storage cp widget-external.js s3://${{ secrets.OBJECT_STORAGE_BUCKET }}/widget-external.js --public-read
            
            echo "Uploading –ü—Ä–æ–º–ø—Ç.json..."
            yc storage cp –ü—Ä–æ–º–ø—Ç.json s3://${{ secrets.OBJECT_STORAGE_BUCKET }}/–ü—Ä–æ–º–ø—Ç.json --public-read
            
            echo "Uploading images/consultant.jpg..."
            yc storage cp images/consultant.jpg s3://${{ secrets.OBJECT_STORAGE_BUCKET }}/images/consultant.jpg --public-read
            
            echo "‚úÖ Static files uploaded"
          else
            echo "‚ö†Ô∏è  OBJECT_STORAGE_BUCKET not set, skipping static files upload"
          fi
      
      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üìù Functions deployed:"
          echo "  - widget-chat"
          echo "  - widget-lead"
          echo "  - widget-analytics"
          echo "  - widget-health"
          echo ""
          echo "üì¶ Static files uploaded to Object Storage bucket: ${{ secrets.OBJECT_STORAGE_BUCKET }}"

