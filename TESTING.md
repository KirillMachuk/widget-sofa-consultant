# Инструкция по тестированию widget-external.js

## Что было сделано

1. ✅ Создан `widget-external.js` с изоляцией стилей
2. ✅ Исправлена генерация `session_id` для уникальности между разными сайтами
3. ✅ Все относительные пути заменены на абсолютные
4. ✅ Улучшена изоляция CSS с использованием `!important`
5. ✅ Улучшена обработка ошибок GAS в `api/lead.js`

## Как протестировать

### 1. Запустите локальный сервер

```bash
cd "/Users/kmachuk/Desktop/Demo боты/Widget"
python3 -m http.server 8000
# или
npx serve .
```

### 2. Откройте тестовую страницу

Откройте в браузере: `http://localhost:8000/test-external.html`

### 3. Тест интеграции с GAS

1. На тестовой странице нажмите кнопку **"Отправить тестовый лид в GAS"**
2. Проверьте результат в разделе "Тест интеграции с GAS"
3. Проверьте Google Sheets - должна появиться новая запись с тестовыми данными

**Ожидаемый результат:** Лид успешно отправляется в GAS и появляется в Google Sheets

### 4. Тест ответов от OpenAI

1. На тестовой странице нажмите кнопку **"Открыть виджет"** или кликните на кнопку виджета в правом нижнем углу
2. В открывшемся чате отправьте вопрос: **"какие есть диваны?"**
3. Проверьте, что бот отвечает корректно

**Ожидаемый результат:** Бот отвечает на вопрос о диванах с полезной информацией

### 5. Проверка изоляции стилей

На тестовой странице специально добавлены конфликтующие стили (Comic Sans MS, красные кнопки, градиентный фон). Виджет должен:
- ✅ Отображаться правильно, несмотря на стили сайта
- ✅ Иметь правильные цвета и шрифты
- ✅ Не быть затронут стилями сайта-хозяина

## Проверка session_id

Виджет теперь генерирует уникальный `session_id` для каждого домена:
- `session_id` включает хеш домена сайта-хозяина
- Это предотвращает конфликты между виджетами на разных сайтах

## Проверка абсолютных путей

Все пути к ресурсам теперь абсолютные:
- Изображения: `${WIDGET_BASE_URL}images/consultant.jpg`
- API endpoints: `${WIDGET_BASE_URL}api/chat`, `${WIDGET_BASE_URL}api/lead`

## Логирование

На тестовой странице есть раздел "Лог событий", который показывает:
- Загрузку виджета
- Ошибки JavaScript
- Результаты тестов

## Устранение проблем

Если виджет не загружается:
1. Проверьте консоль браузера (F12) на наличие ошибок
2. Убедитесь, что сервер запущен
3. Проверьте, что все файлы доступны по правильным путям

Если GAS интеграция не работает:
1. Проверьте URL Google Apps Script в конфигурации
2. Убедитесь, что GAS скрипт развернут с правильными правами доступа
3. Проверьте логи в консоли браузера

Если OpenAI не отвечает:
1. Проверьте, что `OPENAI_API_KEY` установлен в переменных окружения
2. Проверьте логи сервера на наличие ошибок API
3. Убедитесь, что API endpoint доступен


